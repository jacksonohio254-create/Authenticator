<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Secure Authenticator</title>

<link rel="manifest" href="manifest.json">

<style>
body{margin:0;font-family:system-ui;background:#0b1020;color:#fff}
.screen{display:none;padding:20px}
.card{background:#141b3a;padding:15px;border-radius:14px;margin-bottom:12px}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:none}
button{background:#4f7cff;color:white;font-weight:bold}
.code{font-size:30px;letter-spacing:4px}
.small{opacity:.7;font-size:12px}
</style>
</head>
<body>

<!-- PIN LOCK -->
<div id="lock" class="screen">
  <h2>Enter PIN</h2>
  <input id="pin" type="password" inputmode="numeric" maxlength="6">
  <button onclick="unlock()">Unlock</button>
</div>

<!-- APP -->
<div id="app" class="screen">
  <h2>Authenticator</h2>

  <div class="card">
    <input id="name" placeholder="Account name">
    <input id="secret" placeholder="Secret (Base32)">
    <button onclick="addManual()">Add manually</button>
    <input type="file" accept="image/*" onchange="scanQR(this)">
  </div>

  <div id="accounts"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
const enc = new TextEncoder(), dec = new TextDecoder();

function encrypt(text,pin){
  return btoa([...enc.encode(text)].map((b,i)=>b^(pin.charCodeAt(i%pin.length))).join(","));
}
function decrypt(data,pin){
  return dec.decode(new Uint8Array(atob(data).split(",").map((b,i)=>b^(pin.charCodeAt(i%pin.length)))));
}

let PIN = localStorage.getItem("pin");

if(!PIN){
  PIN = prompt("Create a PIN");
  localStorage.setItem("pin", PIN);
}

document.getElementById("lock").style.display="block";

function unlock(){
  if(pin.value===PIN){
    lock.style.display="none";
    app.style.display="block";
    render();
  }
}

let accounts=[];
function load(){
  const raw=localStorage.getItem("vault");
  if(raw) accounts=JSON.parse(decrypt(raw,PIN));
}
function save(){
  localStorage.setItem("vault", encrypt(JSON.stringify(accounts),PIN));
}

function base32Decode(str){
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  let bits="", bytes=[];
  str=str.replace(/=+$/,"").toUpperCase();
  for(let c of str) bits+=chars.indexOf(c).toString(2).padStart(5,"0");
  for(let i=0;i+8<=bits.length;i+=8) bytes.push(parseInt(bits.substr(i,8),2));
  return new Uint8Array(bytes);
}

async function totp(secret){
  const key=base32Decode(secret);
  let epoch=Math.floor(Date.now()/1000/30);
  const msg=new Uint8Array(8);
  for(let i=7;i>=0;i--){msg[i]=epoch&255;epoch>>=8}
  const k=await crypto.subtle.importKey("raw",key,{name:"HMAC",hash:"SHA-1"},false,["sign"]);
  const h=new Uint8Array(await crypto.subtle.sign("HMAC",k,msg));
  const o=h[h.length-1]&15;
  const code=(((h[o]&127)<<24)|(h[o+1]<<16)|(h[o+2]<<8)|h[o+3])%1000000;
  return code.toString().padStart(6,"0");
}

function addManual(){
  accounts.push({name:name.value,secret:secret.value});
  save(); render();
  name.value=secret.value="";
}

function scanQR(input){
  const img=new Image();
  const c=document.createElement("canvas");
  const x=c.getContext("2d");
  img.onload=()=>{
    c.width=img.width;c.height=img.height;
    x.drawImage(img,0,0);
    const d=x.getImageData(0,0,c.width,c.height);
    const qr=jsQR(d.data,c.width,c.height);
    if(!qr)return alert("QR not found");
    const u=new URL(qr.data);
    accounts.push({
      name:u.searchParams.get("issuer")||"Account",
      secret:u.searchParams.get("secret")
    });
    save(); render();
  };
  img.src=URL.createObjectURL(input.files[0]);
}

async function render(){
  load();
  accountsDiv.innerHTML="";
  for(let i=0;i<accounts.length;i++){
    const a=accounts[i];
    const code=await totp(a.secret);
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`<b>${a.name}</b>
    <div class="code">${code}</div>
    <button onclick="del(${i})">Delete</button>`;
    accountsDiv.appendChild(d);
  }
}

function del(i){accounts.splice(i,1);save();render()}
setInterval(render,1000);
</script>

</body>
</html>
