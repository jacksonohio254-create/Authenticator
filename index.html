<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Authenticator</title>

<link rel="manifest" href="manifest.json">

<style>
:root {
  --bg:#0b0f1a;
  --card:#151a33;
  --accent:#4f7cff;
}
body {
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family: system-ui, -apple-system;
}
header {
  padding:18px;
  font-size:22px;
  font-weight:600;
}
.card {
  background:var(--card);
  margin:12px;
  padding:16px;
  border-radius:18px;
}
input,button {
  width:100%;
  padding:12px;
  border:none;
  border-radius:14px;
  margin-top:10px;
  font-size:15px;
}
button {
  background:var(--accent);
  color:#fff;
  font-weight:600;
}
.code {
  font-size:34px;
  letter-spacing:4px;
  margin-top:6px;
}
.issuer {
  opacity:.8;
  font-size:14px;
}
.progress {
  height:4px;
  background:#2a2f55;
  border-radius:5px;
  overflow:hidden;
  margin-top:10px;
}
.bar {
  height:100%;
  background:var(--accent);
}
.hidden { display:none; }
</style>
</head>
<body>

<header>Authenticator</header>

<div id="lock" class="card">
  <h3>Verify to unlock</h3>
  <button onclick="unlock()">Use device security</button>
</div>

<div id="app" class="hidden">
  <div class="card">
    <input id="issuer" placeholder="Issuer (Google, Roblox)">
    <input id="secret" placeholder="Secret key (Base32)">
    <button onclick="add()">Add account</button>
  </div>
  <div id="list"></div>
</div>

<script>
/* ---------- DEVICE AUTH (WebAuthn) ---------- */
async function unlock() {
  try {
    await navigator.credentials.get({
      publicKey: {
        challenge: crypto.getRandomValues(new Uint8Array(32)),
        userVerification: "required",
        timeout: 60000
      }
    });
    lock.classList.add("hidden");
    app.classList.remove("hidden");
    render();
  } catch {
    alert("Verification required");
  }
}

/* ---------- STORAGE ---------- */
let accounts = JSON.parse(localStorage.getItem("vault")||"[]");
function save(){localStorage.setItem("vault",JSON.stringify(accounts));}

/* ---------- TOTP ---------- */
function base32(s){
  const c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  let b="",o=[];
  s=s.replace(/=+$/,"").toUpperCase();
  for(let x of s)b+=c.indexOf(x).toString(2).padStart(5,"0");
  for(let i=0;i+8<=b.length;i+=8)o.push(parseInt(b.slice(i,i+8),2));
  return new Uint8Array(o);
}
async function totp(sec){
  let t=Math.floor(Date.now()/1000/30);
  let msg=new Uint8Array(8);
  for(let i=7;i>=0;i--){msg[i]=t&255;t>>=8}
  let key=await crypto.subtle.importKey("raw",base32(sec),{name:"HMAC",hash:"SHA-1"},false,["sign"]);
  let h=new Uint8Array(await crypto.subtle.sign("HMAC",key,msg));
  let o=h[h.length-1]&15;
  return (((h[o]&127)<<24)|(h[o+1]<<16)|(h[o+2]<<8)|h[o+3])%1e6
    .toString().padStart(6,"0");
}

/* ---------- UI ---------- */
function add(){
  accounts.push({issuer:issuer.value,secret:secret.value});
  save(); issuer.value=secret.value="";
  render();
}

async function render(){
  list.innerHTML="";
  let remain=30-(Math.floor(Date.now()/1000)%30);
  for(let a of accounts){
    let c=await totp(a.secret);
    let d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <div class="issuer">${a.issuer}</div>
      <div class="code">${c}</div>
      <div class="progress"><div class="bar" style="width:${remain/30*100}%"></div></div>
    `;
    list.appendChild(d);
  }
}
setInterval(render,1000);
</script>

</body>
</html>
